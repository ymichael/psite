<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-bd42ed85c54d9cc558de.js" as="script"/><link rel="preload" href="/component---src-templates-post-js-f43e60ad07d7f302c8de.js" as="script"/><link rel="preload" href="/path---2014-03-08-profiling-python-with-cprofile-html-bdca1ec2650ddabea0b4.js" as="script"/><link rel="preload" href="/app-c4fd179fee9f9080d764.js" as="script"/><link rel="preload" href="/commons-61689ac9f897bb0fcb2f.js" as="script"/><title data-react-helmet="true">Profiling python with cProfile - ymichael</title><link data-react-helmet="true" href="//fonts.googleapis.com/css?family=Josefin+Sans:400,600" rel="stylesheet" type="text/css"/><meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/><meta data-react-helmet="true" name="viewport" content="width=device-width"/><style id="gatsby-inlined-css">body,html{font-family:Josefin Sans,sans-serif;font-size:18px;color:#555}.container{padding:10px;padding-bottom:50px;overflow-x:scroll}strong{font-weight:800;color:#111}ul{list-style:none;padding:0;margin:0}sup{font-weight:700;padding:0 2px}blockquote{padding-left:30px;margin-left:0;font-style:italic;border-left:8px solid #ccc}nav{margin-bottom:20px}.navlink{margin:5px}.navlink:first-child{margin-left:0}h1,h2,h3{color:#000}h2{font-size:19px}a{color:#000;text-decoration:none}nav li{display:inline-block}footer{width:100%;opacity:.9;background-color:#fff;position:fixed;bottom:0;padding:0;padding-top:10px;margin:0;height:30px}.olderposts{font-style:italic;font-size:1.2em}.post{margin:30px 0;max-width:100%}#disqus_thread,.post blockquote,.post h1,.post li,.post p,.post ul,.static_content{max-width:500px}.post img{max-height:400px;max-width:95%}@media (min-width:600px){.post img{max-width:125%}}.post .readmore{font-style:italic}.post section :first-child{margin-top:0}.post .post_title{font-size:1.7em;padding:5px 0;margin:0;color:#000}.post time{display:block;font-size:.9em;color:#888}.post code{color:#060606}.post strong{font-weight:700}.post ul{list-style:circle inside}.post li{margin:3px 0}.post pre{display:inline-block;background-color:#f4f4f4;margin-top:.2em;padding:.6em;white-space:pre-wrap;word-wrap:break-word}.footnotes li{margin-bottom:.5em}.footnotes p{display:inline}.footnotes hr{display:none}code[class*=language-],pre[class*=language-]{color:#000;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{position:relative;margin:.5em 0;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;border-left:10px solid #358ccb;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-size:3em 3em;background-origin:content-box;overflow:visible;padding:0}code[class*=language]{max-height:inherit;height:100%;padding:0 1em;display:block;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{position:relative;padding:.2em;border-radius:.3em;color:#c92c2c;border:1px solid rgba(0,0,0,.1);display:inline;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{content:"";z-index:-2;display:block;position:absolute;bottom:.75em;left:.18em;width:40%;height:20%;max-height:13em;box-shadow:0 13px 8px #979797;-ms-transform:rotate(-2deg);transform:rotate(-2deg)}:not(pre)>code[class*=language-]:after,pre[class*=language-]:after{right:.75em;left:auto;-ms-transform:rotate(2deg);transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}.token.cr:before,.token.lf:before,.token.tab:not(:empty):before{color:#e0d7d1}pre[class*=language-].line-numbers{padding-left:0}pre[class*=language-].line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-top:0;padding-bottom:0;padding-left:0}pre[data-line] code{position:relative;padding-left:4em}pre .line-highlight{margin-top:0}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-988817232"><!-- react-empty: 2 --><div class="container" data-reactid="3"><nav data-reactid="4"><ul data-reactid="5"><li class="navlink" data-reactid="6"><a href="/" data-reactid="7">~/</a></li><li class="navlink" data-reactid="8"><a href="/posts" data-reactid="9">posts</a></li><li class="navlink" data-reactid="10"><a target="_blank" href="mailto:wrong92@gmail.com" data-reactid="11">say hi</a></li></ul></nav><div class="static_content" data-reactid="12"><div data-reactid="13"><article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" data-reactid="14"><!-- react-empty: 15 --><header data-reactid="16"><time itemprop="datePublished" datetime="{ post.frontmatter.date }" data-reactid="17">08 March, 2014</time><h1 class="post_title" itemprop="name" data-reactid="18">Profiling python with cProfile</h1></header><section data-reactid="19"><div data-reactid="20"><p>A couple of days ago, I had an assignment for an <a href="//www.comp.nus.edu.sg/~kanmy/courses/3245_2014/index.html">Information Retrieval
class</a>
that basically involved:</p>
<ol>
<li>Indexing a large corpus <em>(Reuters from <code>nltk</code>)</em></li>
<li>Searching it using boolean queries <em>(eg. <code>bill AND gates</code>)</em></li>
</ol>
<p>For the second part of the of the assignment, performance was pretty important.
Since we would want to return results for the user's queries quickly.</p>
<p><strong>This blogpost is basically about how I used python's cProfile to
identify and fix bottlenecks/slow parts in my code.</strong> Most of these bottlenecks
would have been hard to identify without the profiler.</p>
<!--more-->
<p>During my internship at Quora, one of the things I worked on was POST speed
improvements for core actions across the product. It was my first brush with
speed work and the main lesson I took away was the importance of
measuring and profiling before attempting to optimise.</p>
<blockquote>
<p>"Bottlenecks occur ins surprising places, so don't try to second guess and put in a speed hack until you have proven that's where the bottleneck is." - Rob Pike</p>
</blockquote>
<h2>Measure</h2>
<p>After getting a working submission out. I proceeded to measure/benchmark my code. Since
this program was meant to run as a script from the command line, I used the
simple <code>time</code> command-line tool to roughly benchmark how fast my code was.</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ <span class="token function">time</span> python search.py
<span class="token comment"># real    0m1.521s</span>
<span class="token comment"># user    0m1.250s</span>
<span class="token comment"># sys     0m0.142s</span>
</code></pre>
      </div>
<h2>Profile</h2>
<p>Once I was happy with the measurement, I proceeded to profile my code using <code>cProfile</code>.</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ python -m cProfile -o profile_output search.py
</code></pre>
      </div>
<p>The <code>-o</code> flag basically specifies an output filename for cProfile to write its
output to. (Without which, it'll simply spit out the stats to the stdout, which
is undesirable since we'd be unable to sort/drill down into specific functions.)</p>
<h2>Making sense of the cProfile output</h2>
<p>The cProfile output is a basically binary file that contains the following
information:</p>
<p><em>(For each function called in the python program)</em></p>
<ul>
<li>How long each call took (percall, inclusive and exclusive)</li>
<li>How many times it was called (ncalls)</li>
<li>How long it took (cumtime: includes the times of other functions it calls)</li>
<li>How long it actually took (tottime: excludes the times of other functions)</li>
<li>What functions it called (callers)</li>
<li>What functions called it (callees)</li>
</ul>
<p><strong>If you didn't specify the output, you'll basically only get a dump of the
information without the caller/callees part. (Which is quite helpful in making
sense of everything). You'd also lose the ability to dynamically re-sort the
information based on your preferred metric (unless you re-profile it with a <code>-s</code> flag (I think)).</strong></p>
<h3>Reading the cProfile binary output file</h3>
<p>In order to read this binary file, python provides a pstats.Stats class that
happily spits out the various infomation for you in a python shell (when called
with the relevant methods).</p>
<p>I found this rather tedious and <a href="http://blog.ludovf.net/python-profiling-cprofile/">googling</a> <a href="http://pymotw.com/2/profile/">around</a> for an easier way to read this
binary file yield nothing. I just wanted a simple way to:</p>
<ol>
<li>See all the information</li>
<li>Sort them with a single click</li>
<li>Drill down to functions (and their callers and callees) with a single click</li>
</ol>
<p><em>(These as oppose to manually calling methods on the Stats object each time.)</em></p>
<p>So I wrote this: <a href="https://github.com/ymichael/cprofilev">CProfileV</a>. Which is
bacially a thin wrapper for viewing python cProfile output in your browser. Yay!</p>
<p><strong>[UPDATE]: cProfileV has been updated. See <a href="https://github.com/ymichael/cprofilev">https://github.com/ymichael/cprofilev</a> for the latest usage instructions.</strong></p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token comment"># Install cprofilev</span>
$ <span class="token function">sudo</span> pip <span class="token function">install</span> cprofilev

<span class="token comment"># Call it with your cprofile output</span>
$ cprofilev -f /path/to/cprofile/output

<span class="token comment"># Navigate to http://localhost:4000</span>
</code></pre>
      </div>
<p><img src="/static/img/blog/cprofilev1.png" alt="cprofilev1"></p>
<h3>Finding the bottlenecks</h3>
<p>The pstats.Stats object allows you to sort by the various keys and their
combinations. Most often, I find that the most useful sort keys are:</p>
<ul>
<li>cumulative time</li>
<li>total time</li>
<li>calls <em>(to find unneccessary function calls (objects being created in a loop for instance))</em></li>
</ul>
<p>Sorting by total time for me yielded this:</p>
<p><img src="/static/img/blog/cprofilev2-tottime.png" alt="cprofilev2-tottime"></p>
<p>The top line stood out to me. The function <code>not_operation</code> was taking a
suspiciously long time.</p>
<p>Clicking into the <code>not_operation</code> showed that the functions it was calling were
not taking a lot of time. <strong>(Implying that the slowness was due to some code within the function itself.)</strong></p>
<p><img src="/static/img/blog/cprofilev3-not-operation.png" alt="cprofilev3-not-operation"></p>
<div class="gatsby-highlight">
      <pre class="language-py"><code class="language-py"># line 76 of search_index.py
def not_operation(operand, dictionary, pfile):
    """Performs the operation `NOT operand`."""

    # A list of all the documents (sorted)
    all_docs = dictionary.all_docs()

    # A list of the documents matching `operand` (sorted)
    results = get_results(operand, dictionary, pfile, force_list=True)

    return [doc for doc in all_docs if doc not in results]</code></pre>
      </div>
<p>So it turns out that the list comprehension in the function was basically really
<strong>inefficient</strong>. It became super obvious once I narrowed down that <code>not_operation</code>
was slow.</p>
<h3>Optimise/Fix ineffient code</h3>
<p>Excited to have found a possible bottleneck, I quickly implemented a fix.</p>
<div class="gatsby-highlight">
      <pre class="language-py"><code class="language-py"># the fix.
def not_operation(operand, dictionary, pfile):
    """Performs the operation `NOT operand`."""

    # A list of all the documents (sorted)
    all_docs = dictionary.all_docs()

    # A list of the documents matching `operand` (sorted)
    results = get_results(operand, dictionary, pfile, force_list=True)

    return list_a_and_not_list_b(all_docs, results)


def list_a_and_not_list_b(a, b):
    """Returns `a AND NOT b`.

    Both a and b are expected to be sorted lists.

    """
    results = []
    idx_a = 0
    idx_b = 0
    while idx_a < len(a) and idx_b < len(b):
        if a[idx_a] < b[idx_b]:
            results.append(a[idx_a])
            idx_a += 1
        elif b[idx_b] < a[idx_a]:
            idx_b += 1
        else:
            idx_a += 1
            idx_b += 1

    while idx_a < len(a):
        results.append(a[idx_a])
        idx_a += 1

    return results</code></pre>
      </div>
<h2>Measure again</h2>
<p>Measuring the time taken showed promising results. With this fix, the time taken
dropped from roughly 1.5s to 1.15s.</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token function">time</span> python search.py
<span class="token comment"># real    0m1.160s</span>
<span class="token comment"># user    0m1.018s</span>
<span class="token comment"># sys     0m0.133s</span>
</code></pre>
      </div>
<p>Profiling the code showed that the slowness was no longer coming from
<code>not_operation</code>.</p>
<p><img src="/static/img/blog/cprofilev4-not-operation.png" alt="cprofilev4-not-operation"></p>
<h2>Rinse and repeat</h2>
<p>This time though, the most of the time seemed to be spent in the
<code>list_a_and_not_list_b</code> operation.</p>
<p><img src="/static/img/blog/cprofilev5-bool-operation.png" alt="cprofilev5-bool-operation"></p>
<p>In particular, I seemed to be doing ~200k <code>len</code> operations and ~115 <code>append</code>
operations on some list objects.</p>
<p>This seemed like a red-flag so I took a closer look at the
<code>list_a_and_not_list_b</code> function.</p>
<p>It turns out that I really didn't need the while loop at the end of the function.</p>
<div class="gatsby-highlight">
      <pre class="language-python"><code class="language-python"><span class="token comment"># From this.</span>
<span class="token keyword">while</span> idx_a <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">[</span>idx_a<span class="token punctuation">]</span><span class="token punctuation">)</span>
    idx_a <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token comment"># To this.</span>
results<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>a<span class="token punctuation">[</span>idx_a<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
      </div>
<p>Measuring with this new change:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token function">time</span> python search.py
<span class="token comment"># real    0m0.895s</span>
<span class="token comment"># user    0m0.771s</span>
<span class="token comment"># sys     0m0.122s</span>
</code></pre>
      </div>
<p><em>Woot! Got it to run under a second!</em></p>
<h2>Summary</h2>
<p>Overall, I'm pretty happy with the performance gain I got. I did a couple more that I didn't cover here (some other boolean operations were performing poorly under other testcases). Its a pretty cool feeling to methodically find bottlenecks and fix them.</p></div></section></article><br data-reactid="21"/><br data-reactid="22"/><div id="disqus_thread" data-reactid="23"></div></div></div></div><div id="google-analytics" data-reactid="24"></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-c4fd179fee9f9080d764.js","195351340454287":"component---src-templates-post-js-f43e60ad07d7f302c8de.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-b874815858e6e5cf8f5d.js","261085952541737":"component---src-pages-posts-js-46405386cdcb94adf79f.js","60335399758886":"path----557518bd178906f8d58a.js","214762736445329":"path---2012-06-07-i-suck-at-hackathons-html-a1288a810f759a11a84b.js","62720123088807":"path---2012-06-07-remembering-why-i-code-html-0099c9fbd4c90e61eced.js","187134428386528":"path---2012-08-20-my-talent-html-84fb9bccc2389a5aca3f.js","88156359368087":"path---2012-09-03-redesigning-hush-html-57729602eed46f2c056c.js","236515821984100":"path---2012-10-01-disappointed-html-8e9ab573f129718aa727.js","158650160415161":"path---2012-10-02-why-modivle-html-65a6114e562973df657e.js","178220909524583":"path---2012-10-08-decisions-html-e0f058dd12a22d21d5d0.js","62431558595948":"path---2012-11-30-three-down-html-97d3bfc8df437cabe718.js","269751372802256":"path---2013-03-17-deliberately-learn-stuff-html-b1ca5917f17b519aaa07.js","65429831292191":"path---2014-03-08-profiling-python-with-cprofile-html-bdca1ec2650ddabea0b4.js","74653329452217":"path---2014-05-10-javascript-testing-with-karma-js-html-d925c4b358bd7d7d0a6d.js","26019895347478":"path---2014-09-24-build-and-run-eclipse-java-projects-on-the-command-line-html-46ed579feced157edef3.js","2708132243695":"path---2014-12-17-python-testing-with-nose-for-beginners-html-afab4b3da02fe3f36fbc.js","196209814913968":"path---2015-05-28-cprofilev-v-2-html-c19c0290992b9be6a3bc.js","70478302107044":"path---2015-05-28-simple-server-management-with-ansible-html-c1b526138f85149cd11c.js","198956211543598":"path---2015-06-06-some-notes-playing-with-haproxy-html-df2a5db227f52a7007b8.js","231217678519557":"path---2016-04-10-thoughts-page-load-performance-html-4a682ac100c01e01b0e5.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-0eaa9ec956863f723d14.js","140933230050240":"path---posts-cab5beb1caaac4e7b9e5.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-bd42ed85c54d9cc558de.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-61689ac9f897bb0fcb2f.js","/app-c4fd179fee9f9080d764.js","/path---2014-03-08-profiling-python-with-cprofile-html-bdca1ec2650ddabea0b4.js","/component---src-templates-post-js-f43e60ad07d7f302c8de.js","/component---src-layouts-index-js-bd42ed85c54d9cc558de.js"])/*]]>*/</script></body></html>